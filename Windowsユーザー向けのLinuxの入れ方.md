# Windowsユーザー向けLinux環境構築方法

Windowsユーザー向けのLinux環境構築方法は、主に「WSL(Windows Subsystem for Linux)を使用する」方法と「外部メディアにLinux OSをインストールし、第2のOSとしてブートする」方法の2つがある。なお、ここで扱うLinux OSは主にUbuntuを想定している。<p>

---
<br>

WSLは、Windows OS上でLinuxカーネルインターフェースをエミュレートする方法である。

- メリット
    - Windowsを起動したまま、同時にLinux環境を実行することができる
    - CUIを設定するだけであれば、かなり簡単にセットアップができる
    - Linux～Windows間のファイルのやり取りが簡単に行え、Linux側のコマンドをWindowsでも実行することができる

<br>

- デメリット
    - すべてのLinux機能が完全にサポートされているわけではない　(ただし今後のアップデートで改善する余地はある)
    - システムパフォーマンスが本家Linuxに比べて劣る場合がある
    - GUIのサポートが限定的であり、表示にはかなり煩雑な手順が必要である

「主要な開発をWindowsで行い、Linuxは文字通りサブシステムとして使用し、両者の連携をシームレスに行いたい人」向け。

---

<br>

外部メディアにLinux OSをインストールし、第2のOSとしてブートする方法は、その内容通りUSBメモリやHDD、SDカードにLinuxをインストールし、Windowsとは別のOSとして起動させる方法である。
- メリット
    - 完全なLinux環境を利用することができ、すべての機能とパフォーマンスを活用できる
    - 公式にサポートされたGUIを利用することができる

<br>

- デメリット
    - 設定までの手順がやや煩雑である
    - WindowsとLinuxを同時に使う事は出来ない (同時に使いたい場合は、PCが2台必要になる)<p>

「フルスペックでLinuxを使用したい人」向け。

また、外部メディアを使わず、Windowsが入ったドライブに直接Linuxをインストールする方法もあるが、万が一設定を間違えるとWindowsが起動しなくなったり、インストールに成功してもその後のWindows Updateに巻き込まれてLinux側の設定も不調になるケースがあるのでお勧めしない。

---
<br>



# WSL(Windows Subsystem for Linux)を使用する場合

- __CUI(コマンドライン)の導入__

    1.	Windowsを最新の状態にする。

    2.	コントロールパネルを開き、プログラム→Windowsの機能の有効化または無効化の順にクリックする。
    3.	Linux用Windowsサブシステムのチェックボックスを有効化し、OKを押す。それにより設定の変更が行われるので、完了したらPCを再起動する。
    4.	Microsoft Store を開き、Ubuntuを検索する。いくつかバージョンが存在するが、最もバージョンが新しく、末尾にLTS(長期間保守版)がついているものが好ましい。入手をクリックした後に、インストールする。その際にMicrosoft アカウントのログイン等を求めるウィンドウが出ることがあるが、必須ではないので消して問題ない。
    5.	インストール後、起動を押すとユーザーネーム、パスワード設定などの初期設定がCUI上で始まる。それらの完了をもって、WSLによるUbuntuの導入は完了する。その後は、スタートメニューのサイドバーなどからUbuntuを起動することができる。また、エクスプローラーのアドレスバーに`\\wsl$\Ubuntu-22.04`(バージョンはインストールしたもの)と入力すると、UbuntuのシステムファイルをWindowsエクスプローラー上で確認でき、WindowsのGUI上でファイルの移動やフォルダ作成などが行える。
    6.	(任意)WSLをバージョン1からバージョン2にアップデートする。"https://aka.ms/wsl2kernel"にアクセスし、手順4の項目から「x64 マシン用 WSL2 Linux カーネル更新プログラム パッケージ」をダウンロードし、実行する。その後、コントロールパネルから再び「Windowsの機能の有効化または無効化」を表示、「仮想マシンプラットフォーム」を有効にし、OKを押したのち再起動する。その後、コマンドプロンプトで`wsl --set-version Ubuntu-22.04 2`と入力し実行すると、WSLのバージョンが2に変更される。


    参考URL：  
    https://qiita.com/yoshige/items/dbc85b048fba51e597ee

<br>

---

<br>

- __(任意)リモートデスクトップによるGUIの表示__
    - 下記方法は、Windowsを起動しながらUbuntuのGUIも表示できるというメリットがあるが、手順が多く、詰まりポイントが沢山あるのであまり推奨しない。<p>

    1.	上述の方法に従い、WSLをバージョン2にする。

    2.	"https://sourceforge.net/projects/vcxsrv/"にアクセスし、DownloadをクリックしてVcXservをダウンロード、インストールする。

    3.	VcXservのソフトウェアを起動し、以下の設定でサーバーを立ち上げる。
        - Multiple windowsを選択して次へ
        - Start no client を選択して次へ
        - Disable access controlにチェックを入れて次へ(他はデフォルト)
        - 最後の画面で完了を押す
        - ファイアウォールの警告画面が出るので、プライベート、パブリック両方にチェックをつけてアクセス許可を押す<p>  
    4.	UbuntuのCUIを起動し、`sudo apt-get update`、`sudo apt-get install xrdp`　および　`sudo apt-get install lxde`を実行する。
        - この時、システムの日時が正確でないとapt-getのアップデートに失敗するので注意。dateコマンドで現在日時を確認し、もし異なっているようであれば、`sudo date -s "YYYY-MM-DD HH:MM:SS"`コマンドにより、手動で日付を合わせる。<p>

    5.	`sudo sed -i -e 's/^port=3389/port=3390/g' /etc/xrdp/xrdp.ini`をCUIで実行する。
    6.	`echo "export LANG=ja_JP.UTF-8" > ~/.xsessionrc`および`echo "startlxde" >>~/.xsessionrc`をCUIで実行する。
    7.	`sudo service xrdp restart`をCUIで実行する。
    8.	`echo 'export DISPLAY=$(awk "/nameserver / {print $2; exit}" /etc/resolv.conf 2>/dev/null):0' >> ~/.bashrc`および`source ~/.bashrc`を実行する。
    9.	Windowsの検索バーで「リモートデスクトップ接続」を検索し、開く
    10.	コンピューターの部分に`localhost:3390`と入力する。「コンピューターのIDを識別できません。接続しますか？」の表示が出た場合は、はいを押す。
    11.	usernameおよびパスワードの欄に、Ubuntuのインストール時に設定したものをそれぞれ入力してOKを押す。GUIが表示されれば成功。

設定完了後は、
- WSLのUbuntuを起動する
- `sudo service xrdp restart`　を実行する
- リモートデスクトップ接続から`localhost:3390`へアクセスする
- usernameとパスワードを入力する

　上記手順により、GUIを起動できるようになる。なお、VcXservは、GUIを表示するたびに毎回起動と設定をしなければならないはずだが、何故かこの方法では1回設定をするだけで、ソフトを終了してもPC自体を再起動しても特に問題が発生しない。

参考URL：  
https://rin-ka.net/windows-x-server/  
https://scratchpad.jp/ubuntu-on-windows11-9/#toc3

<br>

---

<br>

- __GUIへのWebブラウザの導入__
    1.	適当な場所に、インストーラーをダウンロードするディレクトリを作成する。もしくはcdコマンドでDownloadsなどに移動する。

    2.	`wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb` を実行し、インストーラーをダウンロードする。
    3.	同じディレクトリ(インストーラーがあるディレクトリ)で`sudo apt install ./google-chrome-stable_current_amd64.deb` を実行する。
    4.	GUIを起動し、左下のタスクバーからファイルマネージャーを起動する。その後、アドレスバーに`/opt/google/chrome`と入力すると、chromeがインストールされているので、"chrome"というファイルをクリックするとブラウザが起動する。「Do you want to execute it ?」の表示が出たら、Executeをクリックする。初回起動時に、chromeをデフォルトのブラウザに指定すると、次からはデスクトップ左下のWeb browserから起動できるようになる。

参考URL：  
https://inno-tech-life.com/dev/linux/ubuntu_chrome/

<br>

---

<br>


- __WSLのUbuntuがインターネットに接続できない場合(パッケージの更新に失敗したり、ブラウザでエラーが出る時など)__<p>
    - Windows側のコマンドプロンプトで「ipconfig/all」を実行し、現在使用しているDNSサーバーのアドレスを確認する。次に、そのアドレスをUbuntuのresolv.confに書き込む。具体的には、UbuntuのCUIで「sudo sh -c "echo 'nameserver (DNSサーバーのアドレス)' > /etc/resolv.conf"」を実行する。通常はコマンドプロンプトのipconfigで出てきたアドレスで接続できるが、環境によってはダメな場合もある。その場合は、ルーターの設定画面を確認し、そこに記されているDNSサーバーのアドレスで書き換えれば接続できる可能性がある。ルーターの設定方法は各マニュアルを参照。

    - 例として、バッファロー製ルーターの場合は、ブラウザから「192.168.11.1」にアクセスし、ルーターに記載されたIDとパスワードを入力して設定画面にアクセスする。その後、詳細設定→システムからDNS1(プライマリ)やDNS2(セカンダリ)と言った項目を確認できるので、そのアドレスをUbuntuのresolv.confに上書きする。

参考URL：  
https://qiita.com/ryosukeYamazaki/items/c04ec3ff78aac6eb8d26#%E5%95%8F%E9%A1%8C

<br>

# 外部メディアにLinux OSをインストールし、第2のOSとしてブートする場合

- __準備物__
    - Windows
        - 可能であれば万が一全てのデータが消失してもよいPCが好ましい。または、あらかじめそのPCのリカバリーディスクなどを作成しておく。<p>
    - iso書き込み用メディア
        - 8 GB程度のUSBメモリでOK。インストールディスクのような役割を果たす。<p>
    - Ubuntuインストール用メディア
        - 500 GB以上の外付HDDやSSD等を使用する。ここにUbuntuのシステムファイルをインストールする。USBメモリも使用可能だが、インストールやその後の基本動作が遅くなるので非推奨。

---

<br>

- __書き込み用メディアの作成__

    1. "https://jp.ubuntu.com/download"にアクセスし、最新版のUbuntuのisoをダウンロードする。isoファイルは仮想ディスクであり、CDやDVDなどに書き込まれているデータを抜き出してファイル化したものと考えてよい。

    1. "https://rufus.ie/ja/"にアクセスし、Rufusをダウンロードする。タイプは標準とポータブル版のどちらでも可。RufusはisoをUSBメモリなどのメディアに書き込み、実行可能にするソフトである。
    1. iso書き込み用メディアをPCに差し込み、Rufusを起動する。ユーザーアカウント制御が表示されたら、「はい」をクリックする。更新ポリシーについては、どちらでもよい。
    1. デバイスのタブにて、差し込んだiso書き込み用メディアを指定する(容量やメモリの名前から判別する)。その後、「選択」ボタンをクリックし、ダウンロードしたUbuntuのisoファイルを選択する。
    1. ボリュームラベルの欄にUbuntuが指定されたことを確認したら、「スタート」ボタンを押す。フォーマットオプションはデフォルトで可。その後、USBメモリに書き込む際のモードを選択する画面が出るので、「ISO イメージモードで書き込む (推奨)」が選択されていることを確認し、「OK」をクリックする。この作業により、USB内の全てのデータが削除されるが、問題なければ「OK」をクリックする(新規購入したメモリであれば、初めからデータは入っていない)。
    1. 書き込みが始まるので、しばらく待つ。「状態」の下のプログレスバーが「準備完了」に変化したら、書き込み用メディアの作成は完了。

参考URL：  
https://blog.kabocy.com/linux/5806/


---

<br>

- __インストール用メディアにUbuntuをインストールする__

    1. Windowsを再起動し、BIOS画面を開く。企業ロゴが表示されている間にF2キーを連打することで表示できる。

    1. BOOTに関する設定項目を探し、起動順位をUSBが最上位に来るように設定する。これにより、何らかの書き込みメディア、またばWindowsとは別のOSがインストールされているメディアが接続されている場合に、そちらを優先して起動するようになる。
    1. しばらく待つと、黒い画面上にいくつかのコマンドが表示されるので、「try or install Ubuntu」を選択する。その後、 Ubuntuのインストール画面が表示される。言語設定を日本語に変え、「Ubuntuをインストール」をクリックする。
    1. キーボードレイアウトはJapaneseを選択し、Wi-fi接続画面で、任意のWi-fiに接続する。
    1. アップデートと他のソフトウェアの画面では、「通常のインストール」「Ubuntuのインストール中にアップデートをダウンロードする」「グラフィックスと～」にチェックを入れる。
    1. インストールの種類の画面では、「それ以外」を選択する。__「ディスクを削除してUbuntuをインストール」を選択すると、WindowsのシステムファイルがUbuntuで上書きされ、Windowsが起動しなくなるので厳禁。__
    1. 次の画面では、インストールメディアのサイズ容量を参考に、インストールするデバイス名を特定する。大抵の場合は最下部に表示されている。ディスクを特定したら、「空き領域」を選択して左下の「+」を押す。もしインストールメディアに既に何らかの領域が指定されている場合は、その領域を選択し左下の「-」を押す。
        - __この動作を行うときは、インストールメディアに対してのみ行い、それ以外のデバイスに対しては絶対に行わない。例えば、画面上部の方に表示されている「Windows Boot Manager」と表示されているデバイスで行ってしまうと、Windowsを起動させるシステムが消去され、起動しなくなるので厳禁。__<p>
    1. パーティション作成の画面が出るので、サイズを「512 MB」指定し、「基本パーティション」「この領域の始点」「EFI System Partition」を選択してOK。
    1. 再び空き領域を選択し、「＋」を押す。このパーティション作成では、残りの全ての容量を指定し、「基本パーティション」「この領域の始点」「ext4ジャーナリングシステム」を選択する。また、マウントポイントは「/」を指定する。
    1. 最後に、ブートローダーをインストールするデバイスに、インストールメディアのデバイスを指定する。__デフォルトではWindowsブートマネージャーが存在するデバイスが選択されているので、このデバイス選択を必ず指定のものに変更しておく。__
    1. 「ディスクに書き込みますか？」の画面が出るので、初期化するパーティションの名前に間違いが無ければ「続ける」をクリック。
    1. タイムゾーンはTokyoを指定し、その次の画面でユーザー名やパスワードを設定する。
    1. 「Ubuntuへようこそ」の画面と共に、インストールが始まる。インストールが完了したら、「今すぐ再起動する」をクリック。
    1. その後の黒い画面で`Please remove the installation medium, the press ENTER:`の表示が出るので、書き込み用メディアを取り外してからENTERを押す。間違えてインストールメディアを取り外さないように注意。
    1. その後、Ubuntuが起動すればインストール完了。

参考URL：  
https://demura.net/education/lecture/20509.html  
https://take6shin-tech-diary.com/install_ubuntu2usb/  
https://qiita.com/koba-jon/items/019a3b4eac4f60ca89c9

---

<br>

- __Ubuntuが起動しない場合__
    - 上記操作を完了しても、何らかの原因でUbuntuが起動しない事がある。その場合は以下の方法を試す。<p>

    1. 書き込み用メディアとUbuntuをインストールしたメディアを両方刺し、「try or install Ubuntu」を選択する。

    1. 「Ubuntuを試す」を選択し、Ubuntuの試用モードを起動する。
    1. Ctrl + Alt + Tキーを押し、CUIを起動する。
    1. `sudo add-apt-repository ppa:yannubuntu/boot-repair && sudo apt update` を入力し、実行する。`Press [Enter] to continue or ctrl-c to cancel`の表記が出るので、エンターキーを押す。一連の処理が完了したら、次に`sudo apt install -y boot-repair && boot-repair`を実行する。これにより、Boot Repairというツールをインストールする。
    1. インストールが完了したら、Boot Repairが起動する。起動しない場合は、画面左上のアクティビティから「Boot Repair」を検索することで起動できる。
    1. 「おすすめの修復」を選択し、しばらく待つ。レポートのアップロードは、どちらでも可。
    1. 修復が完了すると、完了画面が表示される。一旦電源を落とし、インストールメデイアのみを接続して再起動すると、黒い画面の上部に「Ubuntu」の文字があるので、それを選択してエンターを押す。
        - 稀に`NVram is locked`の表示が出て、修復が不完全に終わる事があるが、その場合でも一旦電源を落としてインストールメデイアのみを接続し、再起動すると修復に成功している事がある。

参考URL：  
https://kledgeb.blogspot.com/2022/05/ubuntu-2204-120-ubuntuboot-repairubuntu.html  



